name: üöÄ Next.js CI/CD with Docker Hub

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build, Test, and Push Docker Image
    runs-on: ubuntu-latest

    env:
      NEXT_PUBLIC_APP_NAME: ${{ secrets.NEXT_PUBLIC_APP_NAME }}
      NEXT_PUBLIC_ENV: ${{ secrets.NEXT_PUBLIC_ENV }}

    steps:
      # -----------------------------
      # 1Ô∏è‚É£ Checkout repository
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # 2Ô∏è‚É£ Setup Node.js
      # -----------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.12.2
          cache: 'npm'

      # -----------------------------
      # 3Ô∏è‚É£ Install dependencies (smart fallback)
      # -----------------------------
      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          if [ -f package-lock.json ]; then
            echo "‚úÖ package-lock.json found ‚Äî running npm ci"
            npm ci
          else
            echo "‚ö†Ô∏è No package-lock.json found ‚Äî running npm install"
            npm install
          fi

      # -----------------------------
      # 4Ô∏è‚É£ Rebuild native modules
      # -----------------------------
      - name: Rebuild native modules
        run: |
          echo "üîß Rebuilding native modules..."
          npm rebuild @tailwindcss/oxide --verbose || true
          npm rebuild lightningcss --verbose || true
          npm rebuild @next/swc-linux-x64-gnu --verbose || true

      # -----------------------------
      # 5Ô∏è‚É£ Build Next.js app (with secrets)
      # -----------------------------
      - name: Build Next.js app
        run: |
          echo "üèóÔ∏è Building Next.js..."
          echo "NEXT_PUBLIC_APP_NAME=$NEXT_PUBLIC_APP_NAME"
          echo "NEXT_PUBLIC_ENV=$NEXT_PUBLIC_ENV"
          npm run build

      # -----------------------------
      # 6Ô∏è‚É£ Build Docker image
      # -----------------------------
      - name: Build Docker image
        run: |
          echo "üê≥ Building Docker image..."
          docker build \
            --build-arg NEXT_PUBLIC_APP_NAME="$NEXT_PUBLIC_APP_NAME" \
            --build-arg NEXT_PUBLIC_ENV="$NEXT_PUBLIC_ENV" \
            -t nextjs-app:latest .

      # -----------------------------
      # 7Ô∏è‚É£ Run smoke test container
      # -----------------------------
      - name: Run Docker container (smoke test)
        run: |
          echo "üöÄ Starting container for test..."
          docker run -d -p 3000:3000 --name nextjs-container nextjs-app:latest
          echo "‚è≥ Waiting for container startup..."
          sleep 8
          docker ps
          docker logs nextjs-container --tail 20

      # -----------------------------
      # 8Ô∏è‚É£ Verify app health
      # -----------------------------
      - name: Verify app is running
        run: |
          echo "üß™ Checking app health..."
          curl --fail http://localhost:3000 || (echo "‚ùå App failed to start" && exit 1)

      # -----------------------------
      # 9Ô∏è‚É£ Push image to Docker Hub
      # -----------------------------
      - name: Push image to Docker Hub
        if: github.ref == 'refs/heads/main'
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          echo "üîë Logging in to Docker Hub..."
          echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
          IMAGE_NAME="$DOCKER_USERNAME/test-frontend:latest"
          echo "üè∑Ô∏è Tagging image ‚Üí $IMAGE_NAME"
          docker tag nextjs-app:latest "$IMAGE_NAME"
          docker push "$IMAGE_NAME"
          echo "‚úÖ Docker image pushed successfully!"

      # -----------------------------
      # üîü Cleanup
      # -----------------------------
      - name: Cleanup Docker
        if: always()
        run: |
          echo "üßπ Cleaning up containers and images..."
          docker stop nextjs-container || true
          docker rm nextjs-container || true
          docker image prune -f || true
