name: ğŸš€ Next.js CI/CD with Docker Hub

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build, Test, and Push Docker Image
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1ï¸âƒ£ Checkout repository
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # 2ï¸âƒ£ Setup Node.js
      # -----------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.12.2
          cache: 'npm'

      # -----------------------------
      # 3ï¸âƒ£ Clean install dependencies
      # -----------------------------
      - name: Clean install dependencies
        run: |
          echo "ğŸ§¹ Cleaning old dependencies..."
          rm -rf node_modules package-lock.json
          echo "ğŸ“¦ Installing fresh dependencies..."
          npm install

      # -----------------------------
      # 4ï¸âƒ£ Rebuild native modules (for Tailwind/SWC/Linux)
      # -----------------------------
      - name: Rebuild native modules
        run: |
          echo "ğŸ”§ Rebuilding native modules..."
          npm rebuild @tailwindcss/oxide --verbose || true
          npm rebuild lightningcss --verbose || true
          npm rebuild @next/swc-linux-x64-gnu --verbose || true

      # -----------------------------
      # 5ï¸âƒ£ Build Next.js app
      # -----------------------------
      - name: Build Next.js app
        run: |
          echo "ğŸ—ï¸ Building Next.js..."
          npm run build

      # -----------------------------
      # 6ï¸âƒ£ Build Docker image
      # -----------------------------
      - name: Build Docker image
        run: |
          echo "ğŸ³ Building Docker image..."
          docker build -t nextjs-app:latest .

      # -----------------------------
      # 7ï¸âƒ£ Test Docker container
      # -----------------------------
      - name: Run Docker container (smoke test)
        run: |
          echo "ğŸš€ Starting container..."
          docker run -d -p 3000:3000 --name nextjs-container nextjs-app:latest
          echo "â³ Waiting for container startup..."
          sleep 8
          docker ps
          docker logs nextjs-container --tail 20

      # -----------------------------
      # 8ï¸âƒ£ Verify app health
      # -----------------------------
      - name: Verify app is running
        run: |
          echo "ğŸ§ª Checking app health..."
          curl --fail http://localhost:3000 || (echo "âŒ App failed to start" && exit 1)

      # -----------------------------
      # 9ï¸âƒ£ Push to Docker Hub
      # -----------------------------
      - name: Push image to Docker Hub
        if: github.ref == 'refs/heads/main'
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          echo "ğŸ”‘ Logging in to Docker Hub..."
          echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
          
          echo "ğŸ·ï¸ Tagging image..."
          docker tag nextjs-app:latest $DOCKER_USERNAME/nextjs-app:latest

          echo "â¬†ï¸ Pushing image to Docker Hub..."
          docker push $DOCKER_USERNAME/nextjs-app:latest

          echo "âœ… Docker image pushed successfully!"

      # -----------------------------
      # ğŸ”Ÿ Cleanup containers and images
      # -----------------------------
      - name: Cleanup Docker
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up..."
          docker stop nextjs-container || true
          docker rm nextjs-container || true
          docker image prune -f || true
          echo "âœ… Cleanup complete."
